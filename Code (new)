-- Core Services
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

-- Player Setup
local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local root = character:WaitForChild("HumanoidRootPart")
local camera = Workspace.CurrentCamera

-- Configuration Variables
local FLY_DURATION = 2.5
local FLY_SPEED = 50
local REACH_DISTANCE = 18
local ANTI_FALL_HEIGHT = 10
local SAFE_FALL_HEIGHT = 5
local WALL_CLIMB_SPEED = 0.5
local ANTI_VOID_DISTANCE = 50
local NUKE_RADIUS = 18
local ANTI_HIT_TP_HEIGHT = 1000
local SAFE_GROUND_DISTANCE = 4

-- Movement States
local flying = false
local antiHitActive = false
local lastVelocity = Vector3.new(0, 0, 0)

-- Utility Functions
local function getNearbyPlayers()
    local nearbyPlayers = {}
    for _, targetPlayer in ipairs(Players:GetPlayers()) do
        if targetPlayer ~= player and targetPlayer.Character then
            table.insert(nearbyPlayers, targetPlayer)
        end
    end
    return nearbyPlayers
end

-- Fly Function
local function updateFly()
    if flying then
        local moveDir = Vector3.new(0, 0, 0)
        if UserInputService:IsKeyDown(Enum.KeyCode.W) then moveDir = moveDir + camera.CFrame.LookVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.S) then moveDir = moveDir - camera.CFrame.LookVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.D) then moveDir = moveDir + camera.CFrame.RightVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.A) then moveDir = moveDir - camera.CFrame.RightVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.Q) then moveDir = moveDir + Vector3.new(0, 1, 0) end
        if UserInputService:IsKeyDown(Enum.KeyCode.R) then moveDir = moveDir - Vector3.new(0, 1, 0) end
        humanoid.PlatformStand = true
        root.Velocity = moveDir.Unit * FLY_SPEED
    else
        humanoid.PlatformStand = false
    end
end

-- Anti Knockback
local function antiKnockback()
    local currentVelocity = root.Velocity
    local velocityDelta = (currentVelocity - lastVelocity).Magnitude
    if velocityDelta > 50 and currentVelocity:Dot(root.CFrame.LookVector) < -0.7 then
        root.CFrame = CFrame.new(root.Position)
        root.Velocity = Vector3.new(0, 0, 0)
    end
    lastVelocity = currentVelocity
end

-- Nuker/Kill Aura
local function nuker()
    for _, obj in ipairs(Workspace:GetChildren()) do
        if (root.Position - obj.Position).Magnitude < NUKE_RADIUS then
            if obj.Name == "bed" then
                firetouchinterest(root, obj, 0)
                firetouchinterest(root, obj, 1)
                ReplicatedStorage.DefaultChatSystemChatEvents.SayMessageRequest:FireServer("Bed destroyed!", "All")
            elseif obj:FindFirstChild("Humanoid") and obj.Parent ~= character then
                local tool = character:FindFirstChildWhichIsA("Tool") or player.Backpack:FindFirstChildWhichIsA("Tool")
                if tool then
                    for _ = 1, 100 do
                        tool:Activate()
                        RunService.Heartbeat:Wait()
                    end
                end
            end
        end
    end
end

-- Wall Climb
local function wallClimb()
    if UserInputService:IsKeyDown(Enum.KeyCode.W) then
        local raycastDirection = camera.CFrame.LookVector
        local raycastResult = Workspace:Raycast(root.Position, raycastDirection * 5)
        if raycastResult then
            root.Velocity = Vector3.new(0, WALL_CLIMB_SPEED, 0)
        end
    end
end

-- Anti-Hit
local function manageAntiHit()
    local enemiesNear = false
    for _, target in ipairs(Workspace:GetChildren()) do
        if target:FindFirstChild("Humanoid") and target ~= character and (root.Position - target.Position).Magnitude < NUKE_RADIUS then
            enemiesNear = true
            break
        end
    end
    
    if enemiesNear and not antiHitActive then
        antiHitActive = true
        spawn(function()
            while antiHitActive do
                local currentPos = root.Position
                root.CFrame = CFrame.new(Vector3.new(currentPos.X, currentPos.Y + ANTI_HIT_TP_HEIGHT, currentPos.Z))
                task.wait(0.05)
                root.CFrame = CFrame.new(currentPos)
                task.wait(0.05)
            end
        end)
    elseif not enemiesNear and antiHitActive then
        antiHitActive = false
    end
end

-- Anti-Suffocation
local function antiSuffocation()
    local ray = Ray.new(root.Position, Vector3.new(0, -1, 0))
    local hit = Workspace:Raycast(ray.Origin, ray.Direction)
    if hit and hit.Position.Y > root.Position.Y then
        root.CFrame = CFrame.new(root.Position.X, hit.Position.Y + 2, root.Position.Z)
    end
end

-- Anti-Void
local function antiVoid()
    local ray = Ray.new(root.Position, Vector3.new(0, -ANTI_VOID_DISTANCE, 0))
    local hit = Workspace:Raycast(ray.Origin, ray.Direction)
    if not hit then
        local safePosition = Vector3.new(root.Position.X, 10, root.Position.Z)
        root.CFrame = CFrame.new(safePosition)
    end
end

-- Auto Sprint
local function autoSprint()
    humanoid.WalkSpeed = 50
end

-- Anti Fall
local function antiFall()
    if root.Position.Y < SAFE_FALL_HEIGHT then
        local safePosition = Vector3.new(root.Position.X, SAFE_FALL_HEIGHT, root.Position.Z)
        root.CFrame = CFrame.new(safePosition)
    end
end

-- Extend Reach for Attacking
local function extendReach()
    local tool = character:FindFirstChildWhichIsA("Tool")
    if tool then
        local raycastDirection = camera.CFrame.LookVector * REACH_DISTANCE
        local raycastResult = Workspace:Raycast(root.Position, raycastDirection)
        if raycastResult and raycastResult.Instance.Parent and raycastResult.Instance.Parent:FindFirstChild("Humanoid") then
            tool:Activate()
        end
    end
end

-- Auto Toxic Message
local function autoToxic(targetPlayer)
    ReplicatedStorage.DefaultChatSystemChatEvents.SayMessageRequest:FireServer("You killed me, now get ready!", "All")
end

-- Equip Best Gear (Armor/Sword)
local function equipBestGear()
    local bestArmor, bestSword
    for _, item in ipairs(player.Backpack:GetChildren()) do
        if item:IsA("Tool") then
            bestSword = item
        end
        if item:IsA("Clothing") then
            bestArmor = item
        end
    end
    if bestArmor then humanoid:EquipTool(bestArmor) end
    if bestSword then humanoid:EquipTool(bestSword) end
end

-- Main Loop: Runs every frame
RunService.Heartbeat:Connect(function()
    -- Movement Features
    updateFly()
    antiKnockback()
    nuker()
    wallClimb()
    manageAntiHit()

    -- Safety and Interaction Features
    antiSuffocation()
    antiVoid()
    autoSprint()
    antiFall()
    extendReach()
end)

-- Keybinding for Fly Activation
UserInputService.InputBegan:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.C then
        flying = not flying
        if flying then
            task.delay(FLY_DURATION, function()
                flying = false
            end)
        end
    end
end)

-- Equip Best Gear (on startup and when new gear is added)
equipBestGear()
player.Backpack.ChildAdded:Connect(equipBestGear)
